<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><!-- Title --></title>

  <!-- Theme placeholder replaced by render_page -->
  <link rel="stylesheet" href="https://bootswatch.com/5/<!-- Theme -->/bootstrap.min.css">

  <style>
    .post-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap: 1rem; }
    .post-card { min-height: 150px; display:flex; flex-direction:column; }
    .post-thumb { height: 140px; object-fit:cover; width:100%; border-radius:6px 6px 0 0; }
    .post-body { padding: .6rem; flex:1; display:flex; flex-direction:column; justify-content:space-between; }
    .admin-only { /* visible by default; server may append CSS to hide for non-admins */ }
    .small-muted { font-size: .85rem; color:#6c757d; }
    .search-wrap { max-width: 640px; margin:auto; }
    .pagination { justify-content:center; }
  </style>
</head>
<body>

<div class="container py-3">

  <div class="d-flex align-items-center mb-3">
    <h3 class="me-auto mb-0"><!-- Title --></h3>
    <div class="ms-3">
      <select id="categoryFilter" class="form-select">
        <option value="all">All categories</option>
      </select>
    </div>
  </div>

  <div class="search-wrap mb-3">
    <div class="input-group">
      <input id="searchInput" type="search" class="form-control" placeholder="Search by title..." aria-label="Search by title">
      <button id="clearSearch" class="btn btn-outline-secondary" title="Clear">✕</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <span id="resultsInfo" class="small-muted"></span>
    </div>
    <div>
      <button id="prevBtn" class="btn btn-sm btn-outline-primary me-1">Previous</button>
      <button id="nextBtn" class="btn btn-sm btn-outline-primary">Next</button>
    </div>
  </div>

  <!-- POSTS GRID - server injects items as HTML here -->
  <div id="postsContainer" class="post-grid">
    <!-- Database -->
    <!-- Example server-inserted item format (server should inject many of these):
      <div class="card post-item" data-title="My Video Title" data-category="Music" data-stream="ENCODED_URL_HERE">
        <img class="post-thumb" src="THUMB_URL_OR_PLACEHOLDER" alt="Title">
        <div class="post-body">
          <div>
            <h6 class="mb-1">My Video Title</h6>
            <div class="small-muted">Category: Music</div>
          </div>
          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-sm btn-primary watch-btn">Watch</button>
            <a class="btn btn-sm btn-outline-secondary" href="#" download>Download</a>
            <div class="ms-auto admin-only">
              <button class="btn btn-sm btn-outline-warning edit-btn">Edit</button>
              <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
            </div>
          </div>
        </div>
      </div>
    -->
  </div>

  <!-- pagination numbers -->
  <nav aria-label="Page navigation" class="mt-3">
    <ul id="pageNumbers" class="pagination"></ul>
  </nav>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex">
        <div class="mb-2">
          <label class="form-label">Title</label>
          <input id="editTitle" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Category</label>
          <input id="editCategory" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Stream URL (encoded)</label>
          <input id="editStream" class="form-control" placeholder="URL should be encodeURIComponent(...)">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this post?</p>
        <p id="deleteTitle" class="fw-bold"></p>
      </div>
      <div class="modal-footer">
        <button id="cancelDelete" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmDelete" type="button" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS (assume internet access) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* =========================
   Client-side list manager
   ========================= */

const ITEMS_PER_PAGE = 10;

let items = [];         // array of DOM elements (cloned)
let filtered = [];      // filtered list
let currentPage = 1;

// Elements
const postsContainer = document.getElementById('postsContainer');
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const categoryFilter = document.getElementById('categoryFilter');
const resultsInfo = document.getElementById('resultsInfo');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageNumbers = document.getElementById('pageNumbers');

const editModal = new bootstrap.Modal(document.getElementById('editModal'));
const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
const editForm = document.getElementById('editForm');
const editIndex = document.getElementById('editIndex');
const editTitle = document.getElementById('editTitle');
const editCategory = document.getElementById('editCategory');
const editStream = document.getElementById('editStream');
const deleteTitle = document.getElementById('deleteTitle');
const confirmDelete = document.getElementById('confirmDelete');

function initList() {
  // Collect server-injected items (.post-item or .post-card etc.)
  const nodeList = postsContainer.querySelectorAll('.post-item, .card.post-item, .post-card');
  items = Array.from(nodeList).map(n => n.cloneNode(true));

  // if server inserted nothing, try to treat direct children in postsContainer as items
  if (items.length === 0) {
    const fallback = postsContainer.children;
    items = Array.from(fallback).map(n => n.cloneNode(true));
  }

  // populate category dropdown
  populateCategories();

  // attach event handlers to dynamic buttons (watch/edit/delete)
  attachButtons();

  // initial filter & render
  applyFilters();
}

function populateCategories() {
  const cats = new Set();
  items.forEach(node => {
    const cat = (node.dataset.category || '').trim();
    if (cat) cats.add(cat);
  });
  // clear existing except "all"
  categoryFilter.innerHTML = '<option value="all">All categories</option>';
  Array.from(cats).sort().forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    categoryFilter.appendChild(opt);
  });
}

function attachButtons() {
  // delegate event listeners using postsContainer once rendered
  postsContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('button, a');
    if (!btn) return;
    const itemCard = btn.closest('.post-item, .card.post-item, .post-card');
    if (!itemCard) return;

    // WATCH
    if (btn.classList.contains('watch-btn')) {
      const enc = itemCard.dataset.stream || btn.dataset.stream || '';
      if (!enc) return alert('Stream URL missing.');
      try {
        const decoded = decodeURIComponent(enc);
        window.open(decoded, '_blank');
      } catch (err) {
        console.error(err);
        window.open(enc, '_blank');
      }
    }

    // EDIT
    if (btn.classList.contains('edit-btn')) {
      openEditModal(itemCard);
    }

    // DELETE
    if (btn.classList.contains('delete-btn')) {
      openDeleteModal(itemCard);
    }
  });
}

function openEditModal(card) {
  const idx = items.indexOf(card);
  editIndex.value = idx;
  editTitle.value = card.dataset.title || card.querySelector('h6')?.textContent?.trim() || '';
  editCategory.value = card.dataset.category || '';
  editStream.value = card.dataset.stream || '';
  editModal.show();
}

function openDeleteModal(card) {
  const title = card.dataset.title || card.querySelector('h6')?.textContent?.trim() || 'this item';
  deleteTitle.textContent = title;
  confirmDelete.onclick = () => performDelete(card);
  deleteModal.show();
}

async function performDelete(card) {
  // Try to get unique identifier from dataset (server should provide e.g. data-id)
  const id = card.dataset.id || card.dataset.msgid || null;

  // Client-side remove & re-render
  // Server-side endpoint should be implemented to actually delete
  if (id) {
    try {
      await fetch('/admin/delete', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id })
      });
    } catch (err) {
      console.warn('Delete request failed (server may be absent).', err);
    }
  }

  // Remove from items array
  const idx = items.indexOf(card);
  if (idx !== -1) items.splice(idx, 1);

  deleteModal.hide();
  applyFilters();
}

editForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const idx = parseInt(editIndex.value, 10);
  if (Number.isFinite(idx) && items[idx]) {
    const card = items[idx];
    // update dataset
    card.dataset.title = editTitle.value;
    card.dataset.category = editCategory.value;
    card.dataset.stream = editStream.value;

    // also update visible text if present
    const h = card.querySelector('h6');
    if (h) h.textContent = editTitle.value;
    const catSpan = card.querySelector('.small-muted');
    if (catSpan) catSpan.textContent = 'Category: ' + (editCategory.value || '—');

    // Post to server (if your backend supports it)
    const payload = {
      id: card.dataset.id || null,
      title: editTitle.value,
      category: editCategory.value,
      stream: editStream.value
    };
    try {
      await fetch('/admin/edit', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    } catch (err) {
      console.warn('Edit request failed (server may be absent).', err);
    }

    editModal.hide();
    populateCategories();
    applyFilters();
  }
});

/* -------------------------
   Filtering, Pagination
   ------------------------- */

function applyFilters() {
  const q = (searchInput.value || '').trim().toLowerCase();
  const category = categoryFilter.value || 'all';

  filtered = items.filter(node => {
    const title = (node.dataset.title || node.querySelector('h6')?.textContent || '').toLowerCase();
    const cat = (node.dataset.category || '').toLowerCase();
    const titleMatch = title.includes(q);
    const catMatch = category === 'all' ? true : (cat === category.toLowerCase());
    return titleMatch && catMatch;
  });

  currentPage = 1;
  renderPage();
}

function renderPage() {
  // calculate pages
  const total = filtered.length;
  const pages = Math.max(1, Math.ceil(total / ITEMS_PER_PAGE));
  if (currentPage > pages) currentPage = pages;

  const start = (currentPage - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;

  // clear container and append page slice
  postsContainer.innerHTML = '';
  const slice = filtered.slice(start, end);
  slice.forEach(node => postsContainer.appendChild(node.cloneNode(true)));

  // update results text
  const startNum = total === 0 ? 0 : start + 1;
  const endNum = Math.min(end, total);
  resultsInfo.textContent = `Showing ${startNum}–${endNum} of ${total}`;

  // update pagination buttons & numbers
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= pages;
  renderPageNumbers(pages);
}

function renderPageNumbers(pages) {
  pageNumbers.innerHTML = '';
  // show up to 7 page buttons (with ellipsis)
  const maxButtons = 7;
  const half = Math.floor(maxButtons / 2);
  let start = Math.max(1, currentPage - half);
  let end = Math.min(pages, start + maxButtons - 1);
  if (end - start < maxButtons - 1) start = Math.max(1, end - maxButtons + 1);

  for (let i = start; i <= end; i++) {
    const li = document.createElement('li');
    li.className = 'page-item' + (i === currentPage ? ' active' : '');
    const a = document.createElement('a');
    a.className = 'page-link';
    a.href = '#';
    a.textContent = i;
    a.addEventListener('click', (ev) => {
      ev.preventDefault();
      if (currentPage === i) return;
      currentPage = i;
      renderPage();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    li.appendChild(a);
    pageNumbers.appendChild(li);
  }
}

/* -------------------------
   Events
   ------------------------- */

searchInput.addEventListener('input', () => applyFilters());
clearSearch.addEventListener('click', () => { searchInput.value = ''; applyFilters(); });

categoryFilter.addEventListener('change', () => { applyFilters(); });

prevBtn.addEventListener('click', () => {
  if (currentPage > 1) { currentPage--; renderPage(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
});
nextBtn.addEventListener('click', () => {
  const pages = Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE));
  if (currentPage < pages) { currentPage++; renderPage(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
});

/* Initialize after DOM content loaded */
document.addEventListener('DOMContentLoaded', initList);
</script>

</body>
</html>
